/*!
 * ====================================================
 * kityformula-editor - v1.0.0 - 2014-03-10
 * https://github.com/HanCong03/kityformula-editor
 * GitHub: https://github.com/kitygraph/kityformula-editor.git 
 * Copyright (c) 2014 Baidu Kity Group; Licensed MIT
 * ====================================================
 */
!function(){function a(a,b,c){if(d[a]={exports:{},value:null,factory:null},2===arguments.length&&(c=b),"[object Object]"===d.toString.call(c))d[a].value=c;else{if("function"!=typeof c)throw new Error("define函数未定义的行为");d[a].factory=c}}function b(a){var c=d[a],e=null;return c?c.value?c.value:(e=c.factory.call(null,b,c.exports,c),e&&(c.exports=e),c.value=c.exports,c.value):null}function c(a){return b(a)}var d={};a("assembly",[],function(){function a(a,b){this.formula=new kf.Formula(a,b)}function b(a){for(var b,d=null,e=null,f=a.operand||[],g=null,h=0,i=f.length;i>h;h++)d=f[h],d&&"object"==typeof d&&(f[h]=arguments.callee(d));if(g=c(a.name),!g)throw new Error("operator type error: not found "+a.operator);b=function(){},b.prototype=g.prototype,e=new b,g.apply(e,f);for(var j in a.callFn)a.callFn.hasOwnProperty(j)&&e[j]&&e[j].apply(e,a.callFn[j]);return e}function c(a){return d[a]||kf[a.replace(/^[a-z]/i,function(a){return a.toUpperCase()}).replace(/-([a-z])/gi,function(a,b){return b.toUpperCase()})+"Expression"]}var d={};return a.prototype.generateBy=function(a){var c=a.tree;this.formula.appendExpression("string"==typeof c?new kf.TextExpression(c):b(c))},a.prototype.regenerateBy=function(a){return this.formula.clear(),this.generateBy(a)},{use:function(b,c){return new a(b,c)}}}),a("impl/latex/base/checker",[],function(){}),a("impl/latex/base/latex-utils",["impl/latex/base/rpn","impl/latex/base/utils","impl/latex/define/type","impl/latex/base/tree","impl/latex/handler/combination"],function(a){return{toRPNExpression:a("impl/latex/base/rpn"),generateTree:a("impl/latex/base/tree")}}),a("impl/latex/base/rpn",["impl/latex/base/utils","impl/latex/base/checker","impl/latex/define/operator","impl/latex/define/func","impl/latex/handler/func","impl/latex/define/type"],function(a){function b(a){for(var b=[],c=null;c=a.shift();)b.push("object"==typeof c&&c.sign===!1?c.handler(c,b,a):c);return b}var c=a("impl/latex/base/utils");return function(d){var e=[],f=(a("impl/latex/define/type"),null);for(d=b(d);f=d.shift();)e.push(c.isArray(f)?arguments.callee(f):f);return e}}),a("impl/latex/base/tree",["impl/latex/define/type","impl/latex/handler/combination","impl/latex/base/utils","impl/latex/base/checker","impl/latex/define/operator","impl/latex/define/func","impl/latex/handler/func"],function(a){var b=(a("impl/latex/define/type"),a("impl/latex/handler/combination")),c=a("impl/latex/base/utils");return function(a){for(var d=null,e=[],f=0,g=a.length;g>f;f++)c.isArray(a[f])&&(a[f]=arguments.callee(a[f]));for(;d=a.shift();)e.push("object"==typeof d&&d.handler?d.handler(d,e,a):d);return b(e)}}),a("impl/latex/base/utils",["impl/latex/base/checker","impl/latex/define/operator","impl/latex/handler/script","impl/latex/handler/func","impl/latex/define/type","impl/latex/handler/fraction","impl/latex/handler/sqrt","impl/latex/handler/summation","impl/latex/handler/integration","impl/latex/handler/brackets","impl/latex/define/func","impl/latex/handler/lib/int-extract"],function(a){var b=a("impl/latex/base/checker"),c=a("impl/latex/define/operator"),d=a("impl/latex/define/func"),e=a("impl/latex/handler/func"),f={getLatexType:function(a){return a=a.replace(/^\\/,""),c[a]?"operator":d[a]?"function":"text"},isArray:function(a){return a&&"[object Array]"===Object.prototype.toString.call(a)},getDefine:function(a){return f.extend({},c[a.replace("\\","")])},getFuncDefine:function(a){return{name:"function",params:a.replace(/^\\/,""),handler:e}},getBracketsDefine:function(a,b){return f.extend({params:[a,b]},c.brackets)},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}};for(var g in b)b[g]&&b.hasOwnProperty(g)&&(f[g]=b[g]);return f}),a("impl/latex/define/brackets",[],function(){var a=!0;return{".":a,"{":a,"}":a,"[":a,"]":a,"(":a,")":a,"|":a}}),a("impl/latex/define/func",[],function(){return{sin:1,cos:1,arccos:1,cosh:1,det:1,inf:1,limsup:1,Pr:1,tan:1,arcsin:1,cot:1,dim:1,ker:1,ln:1,sec:1,tanh:1,arctan:1,coth:1,exp:1,lg:1,log:1,arg:1,csc:1,gcd:1,lim:1,max:1,sinh:1,cos:1,deg:1,hom:1,liminf:1,min:1,sup:1}}),a("impl/latex/define/operator",["impl/latex/handler/script","impl/latex/handler/func","impl/latex/handler/lib/int-extract","impl/latex/define/type","impl/latex/handler/fraction","impl/latex/handler/sqrt","impl/latex/handler/summation","impl/latex/handler/integration","impl/latex/handler/brackets","impl/latex/define/brackets"],function(a){var b=a("impl/latex/handler/script"),c=(a("impl/latex/handler/func"),a("impl/latex/define/type"));return{"+":{name:"addition"},"-":{name:"subtraction"},times:{name:"multiplication"},div:{name:"division"},cdot:{name:"dot"},cdots:{name:"dots"},ldots:{name:"dots",callFn:{setType:["ldots"]}},vdots:{name:"dots",callFn:{setType:["vdots"]}},ddots:{name:"dots",callFn:{setType:["ddots"]}},"*":{name:"asterisk"},pm:{name:"plus-minus"},mp:{name:"minus-plus"},"<":{name:"lt"},">":{name:"gt"},leq:{name:"leq"},geq:{name:"geq"},sim:{name:"sim"},simeq:{name:"simeq"},approx:{name:"approx"},li:{name:"li"},ge:{name:"ge"},"=":{name:"eq"},equiv:{name:"equiv"},cap:{name:"cap"},cup:{name:"cup"},subset:{name:"subset"},supset:{name:"supset"},subseteq:{name:"subseteq"},supseteq:{name:"supseteq"},"in":{name:"in"},ni:{name:"ni"},sqsupset:{name:"sqsupset"},sqsubset:{name:"sqsubset"},sqsupseteq:{name:"sqsupseteq"},sqsubseteq:{name:"sqsubseteq"},sqcap:{name:"sqcap"},sqcup:{name:"sqcup"},wedge:{name:"wedge"},vee:{name:"vee"},mid:{name:"mid"},"^":{name:"superscript",type:c.OP,handler:b,priority:3},_:{name:"subscript",type:c.OP,handler:b,priority:3},frac:{name:"fraction",type:c.FN,sign:!1,handler:a("impl/latex/handler/fraction")},sqrt:{name:"radical",type:c.FN,sign:!1,handler:a("impl/latex/handler/sqrt")},sum:{name:"summation",type:c.FN,handler:a("impl/latex/handler/summation")},"int":{name:"integration",type:c.FN,handler:a("impl/latex/handler/integration")},brackets:{name:"brackets",type:"TYPE.FN",handler:a("impl/latex/handler/brackets")}}}),a("impl/latex/define/pre",["impl/latex/pre/sqrt","impl/latex/pre/int"],function(a){return{sqrt:a("impl/latex/pre/sqrt"),"int":a("impl/latex/pre/int")}}),a("impl/latex/define/type",[],function(){return{OP:1,FN:2}}),a("impl/latex/handler/brackets",["impl/latex/define/brackets"],function(a){var b=a("impl/latex/define/brackets");return function(a,c,d){for(var e=0,f=a.params.length;f>e;e++)if(!(a.params[e]in b))throw new Error("Brackets: invalid params");return a.operand=a.params,a.params[2]=d.shift(),delete a.handler,delete a.params,a}}),a("impl/latex/handler/combination",[],function(){return function(){return{name:"combination",operand:arguments[0]}}}),a("impl/latex/handler/fraction",[],function(){return function(a,b,c){var d=c.shift(),e=c.shift();if(!d||!e)throw new Error("Frac: Syntax Error");return a.operand=[d,e],delete a.handler,a}}),a("impl/latex/handler/func",["impl/latex/handler/lib/int-extract"],function(a){var b=a("impl/latex/handler/lib/int-extract");return function(a,c,d){var e=b(d);return a.operand=[a.params,e.exp,e.sup,e.sub],delete a.params,delete a.handler,a}}),a("impl/latex/handler/integration",["impl/latex/handler/lib/int-extract"],function(a){var b=a("impl/latex/handler/lib/int-extract");return function(a,c,d){var e=d.shift(),f=b(d);return a.operand=[f.exp,f.sup,f.sub],a.callFn={setType:[0|e]},delete a.handler,a}}),a("impl/latex/handler/lib/int-extract",[],function(){return function(a){var b=a.shift()||null,c=null,d=null;return null!==b&&("string"==typeof b?(d=b,b=null):"superscript"===b.name?(b=a.shift()||null,b&&(c=a.shift()||null,c&&("subscript"===c.name?(c=a.shift()||null,d=a.shift()||null):(d=c,c=null)))):"subscript"===b.name?(c=a.shift()||null,c&&(b=a.shift()||null,b&&("superscript"===b.name?(b=a.shift()||null,d=a.shift()||null):(d=b,b=null)))):(d=b,b=null)),{sub:c,sup:b,exp:d}}}),a("impl/latex/handler/script",[],function(){return function(a,b,c){var d=b.pop(),e=c.shift()||null;if(!e)throw new Error("Missing script");if(d.name===a.name||"script"===d.name)throw new Error("script error");return"subscript"===d.name?(d.name="script",d.operand[2]=d.operand[1],d.operand[1]=e,d):"superscript"===d.name?(d.name="script",d.operand[2]=e,d):(a.operand=[d,e],delete a.handler,a)}}),a("impl/latex/handler/sqrt",[],function(){return function(a,b,c){var d=c.shift(),e=c.shift();return a.operand=[e,d],delete a.handler,a}}),a("impl/latex/handler/summation",["impl/latex/handler/lib/int-extract"],function(a){var b=a("impl/latex/handler/lib/int-extract");return function(a,c,d){var e=b(d);return a.operand=[e.exp,e.sup,e.sub],delete a.handler,a}}),a("impl/latex/latex",["parser","impl/latex/latex","impl/latex/base/latex-utils","impl/latex/base/rpn","impl/latex/base/tree","impl/latex/define/pre","impl/latex/pre/sqrt","impl/latex/pre/int","impl/latex/base/utils","impl/latex/base/checker","impl/latex/define/operator","impl/latex/define/func","impl/latex/handler/func"],function(a){function b(a){var b=h.getLatexType(a);switch(b){case"operator":return h.getDefine(a);case"function":return h.getFuncDefine(a);default:return c(a)}}function c(a){return 0===a.indexOf("\\")?a+"\\":a}function d(a){return a.replace(/\\\s+/,"").replace(/\s*([^a-z0-9\s])\s*/gi,function(a,b){return b})}var e=a("parser").Parser,f=a("impl/latex/base/latex-utils"),g=a("impl/latex/define/pre"),h=a("impl/latex/base/utils"),i="￸",j="￼",k=new RegExp(i+"|"+j,"g"),l=new RegExp(i,"g"),m=new RegExp(j,"g");e.register("latex",e.implement({parse:function(a){var b=this.split(this.format(a));return b=this.parseToGroup(b),b=this.parseToStruct(b),this.generateTree(b)},format:function(a){a=d(a),a=a.replace(k,"").replace(/\\{/gi,i).replace(/\\}/gi,j);for(var b in g)g.hasOwnProperty(b)&&(a=g[b](a));return a},split:function(a){var b=[],c=/(?:\\[a-z]+\s*)|(?:[{}]\s*)|(?:[^\\{}]\s*)/gi,d=/^\s+|\s+$/g,e=null;for(a=a.replace(d,"");e=c.exec(a);)e=e[0].replace(d,""),e&&b.push(e);return b},generateTree:function(a){for(var b=[],c=null;c=a.shift();)b.push(h.isArray(c)?this.generateTree(c):c);return b=f.toRPNExpression(b),f.generateTree(b)},parseToGroup:function(a){for(var b=[],c=[b],d=0,e=0,f=0,g=a.length;g>f;f++)switch(a[f]){case"{":d++,c.push(b),b.push([]),b=b[b.length-1];break;case"}":d--,b=c.pop();break;case"\\left":e++,c.push(b),b.push([]),b=b[b.length-1],b.type="brackets",f++,b.leftBrackets=a[f].replace(l,"{").replace(m,"}");break;case"\\right":e--,f++,b.rightBrackets=a[f].replace(l,"{").replace(m,"}"),b=c.pop();break;default:b.push(a[f].replace(l,"{").replace(m,"}"))}if(0!==d)throw new Error("Group Error!");if(0!==e)throw new Error("Brackets Error!");return c[0]},parseToStruct:function(a){for(var c=[],d=0,e=a.length;e>d;d++)h.isArray(a[d])?"brackets"===a[d].type?(c.push(h.getBracketsDefine(a[d].leftBrackets,a[d].rightBrackets)),c.push(this.parseToStruct(a[d]))):c.push(this.parseToStruct(a[d])):c.push(b(a[d]));return c}}))}),a("impl/latex/pre/int",[],function(){return function(a){return a.replace(/\\(i+)nt(\b|[^a-zA-Z])/g,function(a,b,c){return"\\int "+b.length+c})}}),a("impl/latex/pre/sqrt",[],function(){return function(a){return a.replace(/\\sqrt\s*((?:\[[^\]]*\])?)/g,function(a,b){return"\\sqrt{"+b.replace(/^\[|\]$/g,"")+"}"})}}),a("parser",["impl/latex/latex","parser","impl/latex/base/latex-utils","impl/latex/define/pre","impl/latex/base/utils"],function(a,b,c){function d(a){this.impl=new a,this.conf={}}function e(){this.conf={}}var f={},g={},h={extend:function(a,b){var c=null;b=[].slice.call(arguments,1);for(var d=0,e=b.length;e>d;d++){c=b[d];for(var f in c)c.hasOwnProperty(f)&&(a[f]=c[f])}},setData:function(a,b,c){if("string"==typeof b)a[b]=c;else{if("object"!=typeof b)throw new Error("invalid option");for(c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}}},i={use:function(a){if(!g[a])throw new Error("unknown parser type");return this.proxy(g[a])},init:function(){a("impl/latex/latex")},config:function(a,b){return h.setData(f,a,b),this},register:function(a,b){return g[a.toLowerCase()]=b,this},implement:function(a){var b=function(){},c=a.constructor||function(){},d=function(){e.call(this),c.call(this)};b.prototype=e.prototype,d.prototype=new b,delete a.constructor;for(var f in a)"constructor"!==f&&a.hasOwnProperty(f)&&(d.prototype[f]=a[f]);return d},proxy:function(a){return new d(a)}};h.extend(d.prototype,{config:function(a,b){h.setData(this.conf,a,b)},set:function(a,b){this.impl.set(a,b)},parse:function(a){var b={config:{},tree:this.impl.parse(a)};return h.extend(b.config,f,this.conf),b}}),h.extend(e.prototype,{set:function(a,b){h.extend(this.conf,a,b)},parse:function(){throw new Error("Abstract function")}}),c.exports={Parser:i,ParserInterface:e}}),function(d){var e=b("parser").Parser;e.init(),a("kf.start",function(a){d.kf.Parser=e,d.kf.Assembly=a("assembly")});try{c("kf.start")}catch(f){}}(this)}();